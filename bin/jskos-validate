#!/usr/bin/env node

const fs = require("fs")
const path = require("path")
const { validate } = require(path.join(__dirname, "..", "index.js"))
const args = process.argv.slice(2)

function usage(message) {
  console.log("Usage: jskos-validate [item|concept|...] files...")
  if (message) {
    console.log("")
    console.log(message)
  }
  process.exit(-1)
}

if (!args.length) {
  usage()
}

let type = "item"

if (args[0] in validate) {
  type = args.shift()
} else if (!fs.existsSync(args[0])) {
  usage(`unknown object type: ${args[0]}`)
}

let fail = 0

args.forEach( (file, i) => {
  let data = JSON.parse(fs.readFileSync(file))
  let objects = Array.isArray(data) ? data : [data]
  let status = objects.every(obj => validate[type](obj))

  console.log(`${status ? "\x1b[32mok    " : "\x1b[31mnot ok"}  ${i+1}  ${file}\x1b[0m`)
  fail += status
})

process.exit(fail)
